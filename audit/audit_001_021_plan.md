# AI 审计方案 - 升级后遗留状态清理

## 背景
`audit_001_020_plan_report.md` 显示角色数据在升级后会保留，虽然不构成直接漏洞，但可能导致权限管理复杂化。进一步思考发现其他模块在升级后也可能留下无用的 Box 或全局状态，占用余额甚至影响新版本逻辑。因此，本次计划聚焦于**升级过程中旧状态的清理策略**。

## 目标
1. 统计 `AccessControl`、`RateLimiter` 等模块在升级时会保留的 Box/全局变量。
2. 分析若新版本不再使用这些状态，是否会被恶意利用或造成余额浪费。
3. 设计测试场景：升级到不包含旧状态定义的合约，观察遗留状态的表现。
4. 根据结果提出清理或迁移旧状态的最佳实践建议。

## 审计范围
- `contracts/library/Upgradeable.py`
- `contracts/library/AccessControl.py`
- `contracts/library/RateLimiter.py`
- 相关示例合约与测试脚本

## 方法与步骤
1. **代码审查**
   - 阅读升级流程，记录未被删除或迁移的状态数据。
   - 确认 `complete_contract_upgrade` 及子模块是否提供清理接口。
2. **测试设计**
   - 部署包含多个桶与角色的合约，执行升级到一个简单合约。
   - 观察升级后旧 Box 是否仍存在以及对新版本的影响。
3. **文档检查**
   - 搜索 README 与 DeepWiki，查看是否有关于清理旧状态的指引。

## 预期输出
- 对遗留状态的列表及其潜在影响评估。
- 如无风险，将方向标记为人工否定；如有改进空间，给出清理方法和文档建议。

> 注：本文件仅为审计计划，未执行实际审计工作。
