# AI 审计方案 - RateLimiter 升级遗留 Box 清理

## 背景
- 根据 `pk.md` 断言 #25，升级后旧版合约的 Box 与全局变量不会自动清除，需要手动处理[#25-1]。
- 断言 #27 指出 `AccessControl` 与 `RateLimiter` 使用独立的 `BoxMap` 前缀，升级不会移除旧前缀[#27-1]。
- `audit_002.md` 所述的外部资金依赖方向被认定为治理层面问题，暂无直接漏洞。

## 新方向
评估在升级或删除桶后，是否会遗留 Box 数据导致额外的最低余额占用或被新版本误读。重点关注 `RateLimiter._remove_bucket` 是否彻底删除 Box，以及升级后是否需要迁移或清理旧前缀。

## 审计目标
1. 确认 `_remove_bucket` 是否执行 `BoxMap.delete` 并释放储存。
2. 分析升级完成后旧前缀的 Box 是否仍可被访问，以及对新版本行为的影响。
3. 检查文档与 DeepWiki 是否提醒开发者在升级后手动清理旧 Box。

## 审计步骤
1. **代码审查**
   - 阅读 `RateLimiter._remove_bucket` 实现，验证删除流程。
   - 查阅 `Upgradeable` 升级逻辑，确认是否提供清理旧状态的接口。
2. **实验验证**
   - 在测试环境部署合约，创建并删除桶，记录链上 Box 状态是否仍存在。
   - 升级合约后，再次检查旧前缀的 Box 是否被保留。
3. **文档检查**
   - 搜索 README 与 DeepWiki，确认是否有相关清理指引。

## 预期输出
- 若 Box 数据不会自动清理，应建议在文档或库代码中提供迁移或删除方案。
- 若 Box 能被新版本误读，应评估加入版本前缀或迁移脚本的必要性。

> 注：本文件仅为审计计划，尚未执行实际审计工作。
