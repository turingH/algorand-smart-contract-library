# AI 审计方案 - 版本回滚与重复升级风险

## 背景
`audit_001_023_plan_report.md` 证实 BoxMap 前缀隔离良好，仅需在升级时清理旧数据。为进一步探索 Upgradeable 模块的潜在问题，本计划关注 **升级流程是否允许部署旧版本或重复升级**。由于 `complete_contract_upgrade` 仅校验程序哈希并递增 `version`，若缺乏额外限制，管理员可能回滚到早期版本，重新引入已修复漏洞。

## 目标
1. 审查 `schedule_contract_upgrade` 与 `complete_contract_upgrade` 是否检查版本号或记录已部署的程序哈希。
2. 分析升级到旧程序时链上状态和权限的表现。
3. 设计测试：尝试向旧程序或相同程序升级，观察是否成功及 `version` 变化。
4. 根据结果提出防止降级或重复升级的措施。

## 审计范围
- `contracts/library/Upgradeable.py`
- 相关测试 `tests/library/Upgradeable.test.ts`
- 项目文档

## 方法与步骤
1. **代码审查**
   - 搜索 `Upgradeable` 模块中关于版本和程序哈希的判断逻辑。
   - 检查是否存在对已使用过的哈希或版本的记录与限制。
2. **测试设计**
   - 部署初始版本合约，记录其 `version`。
   - 调度升级到早期程序或相同程序并完成升级，记录结果。
3. **文档检查**
   - 查阅 README 与 DeepWiki（若可访问），确认是否建议避免降级或重复升级。

## 预期输出
- 如发现可以轻易回滚或重复升级，应给出版本管理或哈希白名单建议。
- 若无问题，则将本方向标记为“未发现漏洞”。

> 注：本文件仅为审计计划，暂未执行实际审计工作。
