# AI 审计方案 - BoxMap 结构变更兼容性

## 背景
- `audit_001_032_plan_report.md` 说明 `grant_role` 在资金不足时会完整回滚，但文档缺乏资金说明，属潜在风险。
- `audit_plan_false_finding.md` 与先前多个报告表明库代码未出现实质漏洞，近期方向多被否定。
- 现转向研究升级后继续沿用同一 `BoxMap` 前缀但修改数据结构的情况，评估旧数据被新逻辑误读的风险。

## 新方向
升级到新版本时若沿用旧的 `BoxMap` 前缀并改变内部 `Struct` 字段或含义，旧 Box 内容可能在新合约中被解释为不同的值，引起权限或逻辑异常。本计划审查库中各模块在升级时如何处理此类结构变更，并给出迁移建议。

## 目标
1. 盘点 `AccessControl`、`RateLimiter` 等模块的 `BoxMap` 定义及字段布局。
2. 设计升级场景：旧版本写入若干条目，新版本修改对应结构但保留前缀，观察读取结果。
3. 查阅 README 与 DeepWiki（若可访问），确认是否有关于 Box 数据迁移或版本兼容的指引。
4. 根据评估结果提出数据迁移或版本区分的最佳实践。

## 方法与步骤
1. **代码审查**
   - 搜索 `BoxMap` 的定义及其 `Struct` 类型，记录字段顺序和含义。
   - 检查升级流程 `complete_contract_upgrade` 是否对 Box 数据进行版本检查或迁移。
2. **测试设计**
   - 构建示例合约在旧版本中创建 Box 数据，升级到修改结构的新版本并沿用前缀，读取旧数据查看解析是否异常。
3. **文档检查**
   - 阅读仓库 `README.md` 与 DeepWiki，确认是否提醒开发者在升级时处理 Box 数据结构变更。

## 预期输出
- 若发现旧数据在新结构下会被错误解析，应建议在升级脚本中清理或迁移 Box，并在文档中注明风险。
- 若库已有明确指引或示例处理此场景，可将本方向标记为治理建议。

> 注：本文件仅为审计计划，尚未执行实际审计工作。
