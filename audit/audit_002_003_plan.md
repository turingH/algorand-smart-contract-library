# AI 审计方案 - BoxMap 结构变更兼容性

## 背景
- 根据 `pk.md` 断言 #36，升级时若未清理旧数据，修改 `BoxMap` 的结构会导致旧值被误解读[#36-1]。
- 断言 #28 指出升级流程缺乏结构兼容性检查，需要开发者自行处理迁移[#28-1]。
- 前一方向关于旧角色的持续影响已被证实属于正常业务逻辑，不再深入。

## 新方向
评估在合约升级时 `BoxMap` 结构发生变更的风险，确认是否存在数据解释错误或状态破坏的可能。

## 审计目标
1. 盘点库内各 `BoxMap` 的结构定义，识别可能在未来版本中调整字段或类型的部分。
2. 检查升级逻辑 `Upgradeable.complete_contract_upgrade` 是否有机制检测旧数据与新结构的兼容性。
3. 设计 PoC：在旧结构部署合约并写入样例数据，升级到修改了结构的新版本，读取并比对数据是否异常。
4. 查阅文档与 DeepWiki，确认是否提供结构迁移或清理指导。

## 审计步骤
1. **代码审查**
   - 浏览 `AccessControl`, `RateLimiter` 等模块中 `BoxMap` 声明，标注字段顺序和类型。
   - 对比历史提交或分支，确认是否存在潜在的结构变更场景。
   - 阅读 `Upgradeable.complete_contract_upgrade`，验证升级过程中是否对旧 Box 数据做处理。
2. **PoC 编写**
   - 构建简化的旧版合约，部署并写入示例 Box 数据。
   - 升级到调整了 `BoxMap` 结构的新版合约，读取旧数据并记录解析结果。
   - 人工执行 PoC 以观察是否出现解码错误或逻辑异常。
3. **文档检查**
   - 搜索 README 与 DeepWiki，看是否有关于升级时数据迁移的说明。

## 预期输出
- 如发现结构变更会导致误读，应建议在升级脚本中清理或迁移旧 Box 数据，并在文档中提醒开发者。
- 若未发现直接风险，可在测试与注释中说明目前结构稳定，但建议对未来变更保持兼容或执行迁移。

> 注：本文件仅为审计计划，尚未执行实际审计工作。
