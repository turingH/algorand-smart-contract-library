# AI 审计方案 - 升级后角色持续影响

## 背景
- 根据 `pk.md` 断言 #24，旧角色在升级后仍会保留，可能需要手动清理[#24-1]。
- 断言 #31 指出升级前授予的角色在升级后依旧有效，若新版本改变了权限定义，则可能不一致[#31-1]。
- 前一阶段关注 Box 清理未发现漏洞，现转向检查角色持久化对安全的影响。

## 新方向
分析 `AccessControl` 与 `Upgradeable` 的交互，评估升级后旧角色依然有效时是否会导致权限滥用或与新版本冲突。

## 审计目标
1. 确认升级流程不会自动清理 `roles` 与 `addresses_roles` BoxMap 中的旧数据。
2. 检查新版本若调整角色含义，旧角色持有者是否仍可调用敏感方法。
3. 评估文档或代码中是否提供角色迁移或撤销的示例与指引。

## 审计步骤
1. **代码审查**
   - 阅读 `AccessControl` 的角色存储与查询逻辑，确认升级后数据仍在。
   - 查看 `Upgradeable.complete_contract_upgrade`，验证是否存在清理或迁移角色的实现。
2. **PoC 编写**
   - 部署旧版合约并授予测试账户特定角色。
   - 升级至修改了权限判断的新版本，观察旧角色是否仍可执行原有敏感操作。
3. **文档检查**
   - 搜索 README 及 DeepWiki，确认是否提醒开发者在升级后撤销或迁移旧角色。

## 预期输出
- 若旧角色导致权限不一致，应在文档中说明升级步骤或提供清理脚本。
- 若影响较小，可在注释中提示开发者关注角色一致性。

> 注：本文件仅为审计计划，尚未执行实际审计工作。
