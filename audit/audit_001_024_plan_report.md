# 审计报告：版本回滚与重复升级风险

## 执行摘要

依照 `audit/audit_001_024_plan.md` 的步骤，我们审查了 `Upgradeable` 模块的升级逻辑与现有测试，确认合约升级时**没有记录已部署的程序哈希或限制版本号递增顺序**。因此管理员完全可以调度并执行指向旧程序的升级，`version` 字段仅简单自增。若旧版本存在已修复的漏洞，就可能被重新部署，不过这仍属管理员的自主操作。本次审计未发现文档对降级或重复升级的额外限制或指引。

## 详细审计过程

### 1. 代码审查
- `schedule_contract_upgrade` 在校验调用者权限及时间后，直接存储待升级程序的哈希和时间戳【F:contracts/library/Upgradeable.py†L98-L119】。函数本身不检查哈希是否为历史版本或已部署过。
- `complete_contract_upgrade` 只验证当前链上程序的哈希与计划中的哈希一致，然后删除计划、递增 `version` 并将 `is_initialised` 设为 `False`【F:contracts/library/Upgradeable.py†L139-L171】。代码没有与先前版本作比对，也不会记录已完成的程序哈希。
- 因此，管理员若重新构造旧程序对应的二进制并调度升级，即可在 `version` 增长的同时回滚代码。
- **微断言**：升级逻辑缺乏对程序哈希的历史记录或版本递增校验，允许任意次重复或降级式升级。

### 2. 测试分析
- 现有 `Upgradeable.test.ts` 主要验证升级流程在正常和异常情况下的行为，确保时间戳满足、程序哈希正确以及事件日志等【F:tests/library/Upgradeable.test.ts†L420-L459】。
- 测试并未尝试使用旧程序或相同程序重复升级，也未检查 `version` 是否按预期递增而不允许回滚。
- **微断言**：缺乏针对重复升级或降级的测试覆盖，无法保证此类行为会被拒绝。

### 3. 文档检查
- `README.md` 只描述安装、编译和测试流程，未提及升级安全性或版本管理策略【F:README.md†L1-L60】。
- 由于无法访问 DeepWiki 链接，未能确认是否有进一步的官方指引。
- **微断言**：仓库文档未告知开发者避免降级或记录历史版本的做法，可能导致误用。

## 结论

- **可重演降级**：当前实现允许管理员调度并执行指向旧程序的升级。`version` 只是单调递增，无法阻止相同或更早代码被重新部署。
- **测试和文档缺失**：测试用例未覆盖降级或重复升级场景，文档亦无相关警告，增加误操作风险。
- **建议**：
  1. 在合约中维护已部署程序哈希集合，`schedule_contract_upgrade` 应拒绝已出现过的哈希。
  2. 或结合版本号，在 `complete_contract_upgrade` 处校验新版本必须大于历史最高版本，防止回滚。
  3. 在 README 或 DeepWiki 明确说明升级过程应避免重新部署旧程序，并补充相应的单元测试。

综上，本次审计确认升级模块在设计上允许管理员重新部署旧代码，这在某些场景下可视为回滚功能，并非代码层面的漏洞。然而若旧版本包含已修复的问题，缺乏校验机制可能导致误操作风险。建议在文档中明示这一点，并在有需要时通过记录已部署哈希或限制版本号递增来加强管理。
