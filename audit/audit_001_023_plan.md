# AI 审计方案 - BoxMap 前缀冲突与状态隔离

## 背景
`audit_001_022_plan_report.md` 已确认升级完成到重新初始化之间的权限过渡不会导致直接漏洞。为持续探索新的风险点，本次计划关注 **BoxMap 的 `key_prefix` 设计是否可能在不同模块或合约升级中产生冲突**。若多个模块使用相同前缀，或升级后更改前缀导致旧数据仍被访问，可能造成状态污染或权限错配。

## 目标
1. 审查库中所有 `BoxMap` 定义及其 `key_prefix`，确认是否互相隔离。
2. 评估升级到新版本合约时，如修改 `key_prefix` 或删除相关逻辑，旧数据是否仍可被访问或影响新逻辑。
3. 设计测试场景：部署包含多种 `BoxMap` 的合约，刻意复用或修改前缀，观察数据读取和权限表现。
4. 根据结果提出前缀命名规范或迁移策略，确保跨模块和升级后的状态隔离。

## 审计范围
- `contracts/library/AccessControl.py`
- `contracts/library/RateLimiter.py`
- 其他使用 `BoxMap` 的模块

## 方法与步骤
1. **代码审查**
   - 搜索全库 `BoxMap` 实例化语句，记录 `key_prefix` 值。
   - 检查是否存在重复或过于通用的前缀，例如空字符串或简单常量。
2. **升级流程分析**
   - 思考当合约升级并更改 `key_prefix` 时，旧前缀的 Box 是否仍被保留，是否会造成数据泄露或权限遗留。
3. **测试设计**
   - 编写测试合约模拟前缀冲突：先部署使用前缀 `foo_` 的版本，再升级为前缀 `bar_` 的版本，观察旧数据访问情况。
   - 如果环境允许，模拟两份库合约在同一应用中实例化，检查前缀冲突对数据的影响。
4. **文档检查**
   - 查阅 README 与 DeepWiki，确认是否对前缀命名有推荐或警告。

## 预期输出
- 列出所有 `BoxMap` 的前缀及其用途，评估是否足够独特。
- 如发现潜在冲突，给出命名规范或升级迁移方案。
- 若未发现问题，将该方向标记为人工否定。

> 注：本文件仅为审计计划，暂未执行实际审计工作。
