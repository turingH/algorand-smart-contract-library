# AI 审计方案 - 外部资金依赖
## 更新历史
- 2025-08-09: 经代码审查确认资金不足会导致交易失败并回滚，未见直接漏洞，方向标记为人工否定。
- 2025-08-10: 新方向关注升级或删除桶后的 Box 清理问题，详见 audit_002_001_plan.md。
- 2025-08-11: 新方向关注升级后旧角色仍然存在导致权限不一致的问题，详见 audit_002_002_plan.md。
- 2025-08-12: `audit_002_002_plan_report.md` 认定旧角色持续存在属于正常业务逻辑，方向标记为人工否定。
- 2025-08-13: 新方向关注升级后 `BoxMap` 结构变更可能导致旧数据被误读，详见 audit_002_003_plan.md。


## 背景
- `RateLimiter` 在新增桶时需要在应用账户中提前准备足够的余额以开辟 box（见测试中的 `fundingTxn` 步骤）。
- 合约本身在 `add_bucket` 或相关入口函数中没有检查余额是否足够，也不会在资金不足时自动回滚。
- 因此，如果调用方未正确管理资金，可能导致桶创建失败或产生其他意料之外的状态。

## 参考自 `pk.md` 的已验证知识
`pk.md` 已确认以下内容无需重新审计（除非代码变动）：
1. `_update_capacity` 使用安全的 `ARC4UInt256`、`ARC4UInt64` 类型。
2. `limit * time_delta` 通过 `BigUInt` 处理，最高支持 512 位运算，避免溢出。
3. `duration` 的除法逻辑会将结果限制在 `limit` 以内。
4. `tests/library/RateLimiter.test.ts` 已覆盖极端数值并通过。
5. 函数包含零持续时间的提前返回等逻辑保护。
6. 所有入口在调用 `_update_capacity` 前都会验证桶是否存在。
7. 现有实现下未发现数值溢出问题。

本次审计方案仅关注新增桶时所需资金的依赖及可能的安全隐患。

## 审计目标
1. 确认 `RateLimiter.add_bucket` 等接口在缺少资金时的表现，判断是否会导致意外的状态或部分写入。
2. 评估当前合约是否需要增加余额检查或其他保护措施，以避免开发者疏忽导致创建失败。
3. 验证设计文档及测试流程，确保对资金准备的要求有清晰的说明。

## 审计步骤
1. **代码审查**
   - 阅读 `RateLimiter.add_bucket` 相关实现，确认内部未进行余额校验。
   - 检查合约在开辟 box 失败时的异常处理，确保不会留下半完成的状态。
2. **单元测试设计**
   - 新增测试：故意在未转入足够资金时调用 `add_bucket`，期望交易失败并回滚状态。
   - 在成功场景中验证资金转入后能够正常创建 bucket，且状态如预期更新。
3. **手动复现**
   - 在本地或测试网部署合约，分别执行资金充足与不足的两种场景，记录交易结果与应用状态。
4. **代码修正建议（若适用）**
   - 可以在 `add_bucket` 调用前增加 `balance >= MIN_BALANCE` 的断言，或通过显式的资金管理接口来确保账户足额。
   - 更新文档提醒开发者在新增桶前准备足够余额，同时跟进 audit_002_001_plan.md 对 Box 清理的后续审计。

## 预期结果
- 通过新的测试用例验证资金不足时交易会失败且不会写入任何状态。
- 文档或代码中明确指出新增桶需要的最小资金和准备步骤，避免误用。- 保持 `pk.md` 中已验证的溢出和逻辑安全性不受影响。