# AI 审计方案 - 隐式全局变量持久化验证

## 背景
- `audit_001_034_plan_report.md` 将 `upgradable_admin_role` 常量变更问题定性为治理风险，未发现代码层漏洞。
- 过往审计多聚焦接口权限或升级流程，尚未检查 **Algopy 在未显式声明 `GlobalState` 时是否自动将类属性持久化** 的实现细节。
- `Initialisable.is_initialised` 与 `Upgradeable.version` 等字段直接赋值为 Python 基本类型，可能只是运行时变量，若未持久化则每次调用都会重置，导致权限判断失效。

## 新方向
验证库中未使用 `GlobalState` 声明的属性是否确实被保存到应用全局状态。若这些字段只是临时变量，合约在不同交易间将无法正确维护初始化状态和版本号，可能被反复初始化或多次执行升级。

## 目标
1. 审查 Algopy 对类属性的编译规则，确认 `bool`、`UInt64` 等直接赋值是否自动映射为 `GlobalStateValue`。
2. 通过最小合约实验，在两笔独立交易中读取 `is_initialised` 与 `version`，观察数值是否保持。若重置为默认值，则说明未持久化。
3. 检查 README 与 DeepWiki 是否解释了此类隐式持久化机制，避免开发者误用。

## 方法与步骤
1. **代码审查**
   - 阅读 `Initialisable.__init__` 与 `Upgradeable.__init__` 的实现，追踪相关字段在编译输出中的存储方式。
   - 如有需要，生成 TEAL 代码确认是否存在对应的全局状态槽位。
2. **实验测试**
   - 部署精简合约，仅包含 `is_initialised` 字段和一个查询方法。
   - 依次调用 `initialise`、再调用查询方法，验证状态是否在第二笔交易中保持为 `True`。
   - 对 `version` 字段执行类似实验，观察升级完成后版本号是否递增保存。
3. **文档检查**
   - 搜索仓库文档与 DeepWiki，确认是否有说明“未显式声明 GlobalState 也会自动持久化”的特性。

## 预期输出
- 若字段并未持久化，应提出修改建议：显式使用 `GlobalState` 或在文档中警告开发者勿依赖运行时变量。
- 若 Algopy 已保证自动持久化，则记录这一结论，并在 README 中补充解释，避免误解。

> 注：本文件仅为审计计划，尚未执行实际审计工作。
